---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import Card from "@components/Card";
import Socials from "@components/Socials.astro";
import getSortedPosts from "@utils/getSortedPosts";
import { SITE, SOCIALS } from "@config";
import { getPublications } from "@utils/bibtexUtils";
import { TbArrowRight, TbHeartHandshake } from "react-icons/tb";

const posts = await getCollection("blog");
const publications = await getPublications();

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

const socialCount = SOCIALS.filter((social) => social.active).length;

const getRelatedPubs = (tags: string[]) => {
  return publications.filter(pub => 
    pub.entryTags.keywords && tags.some(tag => pub.entryTags.keywords?.toLowerCase().includes(tag.toLowerCase()))
  ).map(pub => ({ title: pub.entryTags.title || "", url: pub.entryTags.url }));
};
---

<Layout>
  <Header />
  <main id="main-content" class="pt-20 pb-12">
    
    <!-- Hero Section: Editorial Style -->
    <section id="hero" class="flex flex-col items-start sm:items-center sm:text-center max-w-4xl mx-auto mb-24">
      
      <div class="mb-6 opacity-60">
        <span class="font-mono text-xs uppercase tracking-[0.2em] text-skin-accent">Portfolio & Research</span>
      </div>

      <h1 class="font-serif text-5xl sm:text-7xl font-medium leading-[1.1] mb-8 text-skin-base">
        Shravan Goswami
      </h1>

      <div class="w-16 h-[1px] bg-skin-accent/50 mb-8"></div>

      <p class="text-lg sm:text-xl font-light leading-relaxed text-skin-base/80 max-w-2xl">
        Research Assistant at the <span class="font-serif italic text-skin-base">University of Cambridge</span> and Contributor at <span class="font-serif italic text-skin-base">The Julia Language</span>. 
        Exploring the intersection of probabilistic programming and open source.
      </p>

      <div class="mt-10 flex flex-col sm:flex-row gap-6 items-center">
        <LinkButton
          href="/blog/"
          className="px-6 py-3 border border-skin-line hover:border-skin-accent text-sm uppercase tracking-widest transition-all duration-300 hover:bg-skin-accent/5"
        >
          Read Journal
        </LinkButton>
        
        <LinkButton
          href="/projects"
          className="group flex items-center gap-2 text-sm uppercase tracking-widest text-skin-base/60 hover:text-skin-accent transition-colors"
        >
          <span>View Works</span>
          <TbArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
        </LinkButton>
      </div>

      {
        socialCount > 0 && (
          <div class="mt-12 scale-90 opacity-70 hover:opacity-100 transition-opacity">
            <Socials centered />
          </div>
        )
      }
    </section>

    {
      featuredPosts.length > 0 && (
        <>
          <section id="featured" class="max-w-4xl mx-auto">
            <div class="flex items-center gap-4 mb-8">
               <h2 class="font-serif text-2xl italic text-skin-base">Selected Writings</h2>
               <div class="h-[1px] flex-1 bg-skin-line/30"></div>
            </div>
            
            <ul class="grid gap-4">
              {featuredPosts.map(({ data, slug }) => (
                <Card
                  href={`/blog/${slug}/`}
                  frontmatter={data}
                  secHeading={false}
                  relatedPublications={getRelatedPubs(data.tags)}
                />
              ))}
            </ul>
          </section>
        </>
      )
    }

    {
      recentPosts.length > 0 && (
        <section id="recent-posts" class="max-w-4xl mx-auto mt-24">
          <div class="flex items-center gap-4 mb-8">
             <h2 class="font-serif text-2xl italic text-skin-base">Recent Notes</h2>
             <div class="h-[1px] flex-1 bg-skin-line/30"></div>
          </div>
          
          <ul class="grid gap-4">
            {recentPosts.map(
              ({ data, slug }, index) =>
                index < SITE.postPerIndex && (
                  <Card
                    href={`/blog/${slug}/`}
                    frontmatter={data}
                    secHeading={false}
                    relatedPublications={getRelatedPubs(data.tags)}
                  />
                ),
            )}
          </ul>
          
          <div class="mt-12 text-center">
            <LinkButton href="/blog/" className="font-mono text-xs uppercase tracking-widest text-skin-base/50 hover:text-skin-accent transition-colors">
              View Archive &rarr;
            </LinkButton>
          </div>
        </section>
      )
    }

    <div class="mt-24 max-w-2xl mx-auto p-8 border border-skin-line/20 rounded-sm text-center">
      <TbHeartHandshake className="w-8 h-8 mx-auto mb-4 text-skin-accent/60" />
      <h3 class="font-serif text-xl mb-2">Patronage</h3>
      <p class="text-sm text-skin-base/60 mb-6 font-light">
        If my open-source contributions have added value to your work, consider supporting the continued development.
      </p>
      <iframe
        src="https://github.com/sponsors/shravanngoswamii/button"
        title="Sponsor shravanngoswamii"
        height="32"
        width="114"
        style="border: 0; margin: 0 auto; filter: grayscale(100%); opacity: 0.8;"
        class="hover:filter-none hover:opacity-100 transition-all duration-500"
      ></iframe>
    </div>

  </main>

  <Footer />
</Layout>
