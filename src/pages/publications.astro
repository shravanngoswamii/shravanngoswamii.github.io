---
import { SITE } from "@config";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import { getPublications, processLatex, type Publication } from "@utils/bibtexUtils";
import { getCollection } from "astro:content";
import getSortedPosts from "@utils/getSortedPosts";
import { TbArrowRight } from "react-icons/tb";

const publications = await getPublications();

// Fetch and sort blog posts
const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);

// Sort publications by year (descending)
publications.sort((a: Publication, b: Publication) => {
  const yearA = a.entryTags.year ? parseInt(a.entryTags.year) : 0;
  const yearB = b.entryTags.year ? parseInt(b.entryTags.year) : 0;
  return yearB - yearA;
});

const groupedPublications = {
  "Published Work": [] as Publication[],
  "Preprints & Manuscripts": [] as Publication[],
  "Talks & Presentations": [] as Publication[],
  "Peer Review": [] as Publication[],
};

publications.forEach((pub) => {
  const keywords = pub.entryTags.keywords
    ? pub.entryTags.keywords.toLowerCase()
    : "";
  if (keywords.includes("peer-review") || keywords.includes("review")) {
    groupedPublications["Peer Review"].push(pub);
  } else if (keywords.includes("preprint") || keywords.includes("manuscript")) {
    groupedPublications["Preprints & Manuscripts"].push(pub);
  } else if (keywords.includes("talk") || keywords.includes("presentation")) {
    groupedPublications["Talks & Presentations"].push(pub);
  } else {
    groupedPublications["Published Work"].push(pub);
  }
});

// Helper function to process LaTeX formatting
// Moved to @utils/bibtexUtils

const getRelatedPosts = (pub: Publication) => {
  if (!pub.entryTags.keywords) return [];
  const keywords = pub.entryTags.keywords.toLowerCase().split(",").map(k => k.trim());
  return sortedPosts.filter(post => 
    post.data.tags.some(tag => keywords.includes(tag.toLowerCase()))
  );
};
---

<Layout title={`Publications | ${SITE.title}`}>
  <Header activeNav="publications" />

  <Main
    pageTitle="Publications"
    pageDesc="A collection of my research papers, articles, and conference proceedings."
  >
    <div class="space-y-12">
      {
        Object.entries(groupedPublications).map(
          ([category, pubs]) =>
            pubs.length > 0 && (
              <div class="space-y-4">
                <h2 class="text-xl font-bold text-skin-base border-b border-skin-line/20 pb-2">
                  {category}
                </h2>
                <ul class="space-y-0">
                  {pubs.map((pub: Publication) => (
                    <li class="py-3 border-b border-skin-line/10 last:border-none">
                      <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-baseline gap-4">
                          <h3 class="text-lg font-bold text-skin-base leading-snug">
                            {pub.entryTags.url ? (
                              <a
                                href={pub.entryTags.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-skin-accent hover:underline decoration-dashed underline-offset-4 transition-colors duration-200"
                              >
                                <span
                                  set:html={processLatex(pub.entryTags.title)}
                                />
                              </a>
                            ) : (
                              <span
                                set:html={processLatex(pub.entryTags.title)}
                              />
                            )}
                          </h3>
                          {pub.entryTags.year && (
                            <span class="text-sm text-skin-base/60 shrink-0">
                              {pub.entryTags.year}
                            </span>
                          )}
                        </div>

                        <div class="text-sm text-skin-base/90">
                          <span
                            set:html={processLatex(pub.entryTags.author)}
                          />
                        </div>

                        <div class="text-xs text-skin-base/60 italic">
                          {pub.entryTags.journal && (
                            <span>{pub.entryTags.journal}</span>
                          )}
                          {pub.entryTags.booktitle && (
                            <span>{pub.entryTags.booktitle}</span>
                          )}
                          {pub.entryTags.publisher && (
                            <span>{pub.entryTags.publisher}</span>
                          )}
                          {pub.entryTags.note && (
                            <span class="inline-flex items-center gap-1">
                              {(pub.entryTags.journal ||
                                pub.entryTags.booktitle ||
                                pub.entryTags.publisher) && (
                                <span class="not-italic opacity-50 mx-1">â€¢</span>
                              )}
                              <span
                                set:html={processLatex(pub.entryTags.note)}
                              />
                            </span>
                          )}
                        </div>

                        {getRelatedPosts(pub).length > 0 && (
                          <div class="mt-2 pt-1">
                            <span class="text-xs font-bold uppercase tracking-wider text-skin-base/50 mb-1 block">
                              My Companion Blog Post{getRelatedPosts(pub).length > 1 ? "s" : ""}
                            </span>
                            <ul class="space-y-1">
                              {getRelatedPosts(pub).map(post => (
                                <li class="flex items-start gap-2 text-xs group">
                                  <TbArrowRight className="h-3.5 w-3.5 text-skin-base/50 shrink-0 mt-0.5 group-hover:text-skin-accent transition-colors" />
                                  <a href={`/blog/${post.slug}/`} class="text-skin-base/70 hover:text-skin-accent hover:underline decoration-dashed underline-offset-4 transition-colors">
                                    {post.data.title}
                                  </a>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            ),
        )
      }

      {
        publications.length === 0 && (
          <p class="text-skin-base opacity-75">No publications found.</p>
        )
      }
    </div>
  </Main>
  <Footer />
</Layout>
